# Mandala & Emotions Map

## Mandala Structure — Flexible MapDefinition

Maps in Yinflow use a **flexible MapDefinition** structure where each slice defines its own cells. This is NOT a uniform grid — different slices can have different numbers and types of cells.

### Key Types (shared/types/MandalaTypes.ts)

- `MapDefinition` — top-level map: center + slices
- `MapSliceDef` — a slice with angular range and its own cells
- `MapCellDef` — a cell with radial position (innerRatio/outerRatio) and content metadata
- `MapCenterDef` — the shared center cell
- `MandalaState` — `Record<string, CellState>` with one entry per cell
- `CellState` — `{ status: CellStatus, contentShapeIds: SimpleShapeId[] }`

## Emotions Map — 7 Cells

The Emotions Map has **7 cells** (not 18), organized into 3 slices + 1 shared center:

### Slice Layout (Angular)

- **Past**: 150° to 270° (left side)
- **Future**: 270° to 30° (right side)
- **Present**: 30° to 150° (top)

### Cells per Slice

| Slice | Outer Cell (0.467–1.0) | Inner Cell (0.2–0.467) |
|-------|----------------------|----------------------|
| Past | `past-events` | `past-thoughts-emotions` |
| Future | `future-events` | `future-beliefs` |
| Present | `present-behaviors` | `present-beliefs` |

### Center Cell

- `evidence` — shared by all slices, radius ratio 0.2

### All Valid Cell IDs

```
evidence, past-events, past-thoughts-emotions, future-events, future-beliefs, present-behaviors, present-beliefs
```

## Geometry Functions (client/lib/mandala-geometry.ts)

All functions take a `MapDefinition` as the first parameter:

- `getAllCellIds(map)` — returns all cell IDs (center first, then slices)
- `isValidCellId(map, cellId)` — validates a cell ID against the map
- `getCellAtPoint(map, center, outerRadius, point)` — point-to-cell hit testing
- `getCellCenter(map, center, outerRadius, cellId)` — center point of a cell
- `makeEmptyState(map)` — creates an empty MandalaState for the map

## Framework Config (client/lib/frameworks/emotions-map.ts)

The `EMOTIONS_MAP` constant is a `MapDefinition` that defines all 7 cells with:
- `question` — the Socratic question AI asks for each cell
- `guidance` — tips for the AI
- `examples` — sample answers
- `innerRatio` / `outerRatio` — radial position as fraction of outer radius

## Verification

Run `bun run verify` before delivering any changes.

Consider these rules if they affect your changes.
